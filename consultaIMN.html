<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>GET IMN</title>
    <style>
        :root {
            --hv-color: rgb(255, 213, 173);
        }

        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex: 0;
            flex-direction: column;
            background: url('https://www.imn.ac.cr/imagenes-sat/TCLCR.gif');
            background-color: #212121;
            background-size: 95% 100%;
            background-position: 50% 0;
            background-repeat: no-repeat;
            font-family: sans-serif;
            height: 100vh;
            color: white;
        }

        @media screen and (max-width: 1220px) {
            body {
                background-size: auto;
                background-position: 0 0;
                background-repeat: repeat;
            }
        }

        h2 {
            margin-top: 0;
        }

        select {
            width: 25%;
            height: 30px;
            border-radius: 5px;
            border: 1px solid black;
            font-size: 20px;
        }

        .hidden {
            display: none;
        }

        .inactive>td {
            background-color: rgb(231, 231, 231);
        }

        .header,
        h1,
        h2 {
            text-align: center;
            text-shadow:
                -1px -1px 0 #000,
                1px -1px 0 #000,
                -1px 1px 0 #000,
                1px 1px 0 #000;
        }

        .mainPage {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-height: 100vh;
        }

        .queryPage {
            border: 1px solid rgb(194, 116, 43);
            border-radius: 7px;
            box-shadow: 0 0 15px black;
            background-color: rgba(255, 146, 51, 0.226);
            padding: 2.2%;
            width: 40%;
            text-align: center;
            margin: 0 auto;
            margin-top: 1%;
        }

        .locSel {
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        .tableScroll {
            overflow-y: scroll;
            height: 250px;
            width: 100%;
            border: 3px solid rgb(0, 0, 0);
            border-radius: 3px;
            margin: 0 auto;
        }

        .s-1 {
            height: 5vh;
        }

        tr:has(td:hover)>td {
            background-color: var(--hv-color);
        }

        thead {
            position: sticky;
            top: 0;
        }

        table {
            margin: 0 auto;
            width: 100%;
            border-spacing: 0;
            color: black;
        }

        tr {
            width: 100%;
            height: 50px;
        }

        th {
            border: 1px solid black;
            width: 33%;
            background-color: rgb(255, 255, 255);
        }

        td {
            border: 1px solid black;
            width: 33%;
            background-color: rgb(255, 255, 255);
            user-select: none;
        }
    </style>
</head>

<body>
    <div class="mainPage">
        <div class="header">
            <h1>Tablas de datos IMN</h1>
        </div>
        <div class="queryPage" id="q1">

            <h2>Seleccione una provincia</h2>
            <select id="provSel">
                <option value="-1" selected disabled>[Provincia]</option>
                <option value="0">San José</option>
                <option value="1">Alajuela</option>
                <option value="2">Cartago</option>
                <option value="3">Heredia</option>
                <option value="4">Puntarenas</option>
                <option value="5">Guancaste</option>
                <option value="6">Limón</option>
            </select>


        </div>

        <div class="queryPage hidden" id="q2">
            <p id="provTxt" class="hidden"></p>
            <div class="locSel hidden">
                <h2>Seleccione un lugar:</h2>
                <div class="tableScroll">
                    <table id="locTable">
                        <thead>
                            <tr>
                                <th>Lugar</th>
                                <th>Región</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>

                        </tbody>

                    </table>
                </div>
            </div>
        </div>

        <div class="queryPage hidden" id="r1">
            <p id="resTxt" class="hidden"></p>
            <div class="locRes hidden">

            </div>
            <button id="backBtn">Volver</button>
        </div>
    </div>
</body>
<script>
    let listaRaw = [];
    let listaLugares = [{
        "id": 0,
        "name": "San José",
        "lugares": []
    },
    {
        "id": 1,
        "name": "Alajuela",
        "lugares": []
    },
    {
        "id": 2,
        "name": "Cartago",
        "lugares": []
    },
    {
        "id": 3,
        "name": "Heredia",
        "lugares": []
    },
    {
        "id": 4,
        "name": "Puntarenas",
        "lugares": []
    },
    {
        "id": 5,
        "name": "Guanacaste",
        "lugares": []
    },
    {
        "id": 6,
        "name": "Limón",
        "lugares": []
    }];

    let q1 = document.getElementById('q1');
    let q2 = document.getElementById('q2');
    let r1 = document.getElementById('r1');
    let locSel = document.querySelector('.locSel');
    let locRes = document.querySelector('.locRes');
    let provTxt = document.getElementById('provTxt');
    let resTxt = document.getElementById('resTxt');

    let backBtn = document.querySelector('#backBtn');

    let provListed = false;
    document.getElementById('provSel').addEventListener('change', async () => {
        q2.classList.remove('hidden');
        provTxt.classList.remove('hidden');
        provTxt.innerText = "Consultando provincia...";
        if (!provListed) {
            provListed = await listLugares();
            if (!provListed) {
                console.log("Error en listLugares");
                document.getElementById('provTxt').innerText = "No se pudo realizar la consulta.";
                return;
            }
        }
        provTxt.classList.add('hidden');
        locSel.classList.remove('hidden');

        let tdLugares = "";
        for (x of listaLugares) {
            if (x.id == document.getElementById('provSel').value) {
                for (y of x.lugares) {
                    tdLugares += `<tr href="${y.url}" onclick="clickRow(event)" ${y.estado == 'Inactivo' || y.estado == 'Mantenimiento' ? 'class="inactive"' : ''}>
                            <td>${y.lugar}</td>
                            <td>${y.region}</td>
                            <td>${y.estado}</td>
                        </tr>`;

                }
            }

            document.querySelector('#locTable > tbody').innerHTML = tdLugares;

        }
    })

    backBtn.addEventListener('click', () => {
        backBtn.classList.add('hidden');
        q1.classList.remove('hidden');
        q2.classList.remove('hidden');
        r1.classList.add('hidden');
    })

    async function clickRow(event) {
        locRes.innerHTML = "";
        q1.classList.add('hidden');
        q2.classList.add('hidden');
        r1.classList.remove('hidden');
        resTxt.classList.remove('hidden');
        resTxt.innerText = "Consultando ubicación...";
        backBtn.classList.add('hidden');
        let queryURL = event.target.parentNode.getAttribute('href')

        try {
            const response = await fetch("https://api.allorigins.win/get?url=" + encodeURIComponent(queryURL), {
                method: 'GET',
                headers: {

                }
            });

            const data = await response.json();
            console.log(data.contents);

            const parser = new DOMParser();
            const doc1 = parser.parseFromString(data.contents, 'text/html');

            const dLocs1 = doc1.querySelectorAll('tbody');
            const dTable = "https://www.imn.ac.cr" + doc1.querySelector('#datos').getAttribute('src');
            console.log(dTable);
            try {
                const response = await fetch("https://api.allorigins.win/get?url=" + encodeURIComponent(dTable), {
                    method: 'GET',
                    headers: {

                    }
                });

                const data = await response.json();
                console.log(data.contents);

                const parser = new DOMParser();
                const doc2 = parser.parseFromString(data.contents, 'text/html');

                const dLocs2 = doc2.querySelectorAll('table');
                console.log(dLocs2);

                locRes.classList.remove('hidden');
                locRes.innerHTML = dLocs1[0].querySelector("h4").outerHTML + dLocs2[1].outerHTML + dLocs2[2].outerHTML;

                backBtn.classList.remove('hidden');
                resTxt.classList.add('hidden');


            } catch (error) {
                console.log("Error en clickRow" + error.message);
                resTxt.innerText = "No se pudo realizar la consulta.";
                backBtn.classList.remove('hidden');
                return;
            }


        } catch (error) {
            console.log("Error en clickRow" + error.message);
            resTxt.innerText = "No se pudo realizar la consulta.";
            backBtn.classList.remove('hidden');
            return;
        }
    }

    async function listLugares() {
        document.getElementById('provTxt').innerText = "Consultando provincia...";
        const url = 'https://api.allorigins.win/get?url=' + encodeURIComponent('https://www.imn.ac.cr/web/imn/estaciones-automaticas');

        try {
            const response = await fetch(url, {
                method: 'GET',
                headers: {

                }
            });

            const data = await response.json();
            console.log(data.contents);

            const parser = new DOMParser();
            const doc = parser.parseFromString(data.contents, 'text/html');

            const dLocs = doc.querySelectorAll('tbody > tr');

            for (x of dLocs) {
                let data = x.querySelectorAll('td');
                let lugar = data[0];
                if (lugar.querySelector("p") != null) {
                    lugar = lugar.querySelector("p").innerHTML.trim();
                } else {
                    lugar = lugar.innerHTML.trim();
                }
                let region = data[1].innerHTML.split("-")[0].trim();
                let provincia = data[1].innerHTML.split("-")[1].trim();
                let estado = data[2];
                if (estado.querySelector("span") != null) {
                    estado = estado.querySelector("span").innerHTML.replace("va", "vo").trim();
                } else {
                    estado = estado.innerHTML.replace("va", "vo").trim();
                }
                let url = data[3].querySelector("a").href;

                listaRaw.push({
                    lugar: lugar,
                    region: region,
                    provincia: provincia,
                    estado: estado,
                    url: url
                })
            }

            console.log(listaRaw);

            for (x of listaRaw) {
                switch (x.provincia) {
                    case "San José":
                        listaLugares[0].lugares.push(x);
                        break;
                    case "Alajuela":
                        listaLugares[1].lugares.push(x);
                        break;
                    case "Cartago":
                        listaLugares[2].lugares.push(x);
                        break;
                    case "Heredia":
                        listaLugares[3].lugares.push(x);
                        break;
                    case "Puntarenas":
                        listaLugares[4].lugares.push(x);
                        break;
                    case "Guanacaste":
                        listaLugares[5].lugares.push(x);
                        break;
                    case "Limón":
                        listaLugares[6].lugares.push(x);
                        break;
                }
            }

            for (z in listaLugares) {
                listaLugares[z].lugares.sort((a, b) => {
                    if (a.lugar < b.lugar) {
                        return -1;
                    }
                    if (a.lugar > b.lugar) {
                        return 1;
                    }
                    return 0;
                })
            }

            return true;

        } catch (error) {
            console.log("Error: " + error.message);
            return false;
        }
    }
</script>

</html>