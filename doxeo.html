<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super doxeo CR</title>
    <style>
        table {
            padding: 5px;
            border: 3px solid black;
            border-collapse: collapse;
        }

        td {
            padding: 5px;
            border: 1px solid black;
            min-width: 50px;
        }
    </style>
</head>

<body>
    <h1>Hola</h1>
    <h3>Ingrese un número de teléfono</h3>
    <input type="text" id="txt">

    <button id="btnConsultar">Consultar</button>

    <p id="status"></p>

    <table id="resultado" style="display: none;">
        <tr>
            <td>Cédula</td>
            <td>Nombre</td>
            <td>Edad</td>
            <td>Nacimiento</td>
            <td>Provincia</td>
            <td>Teléfono</td>
        </tr>
        <tbody>
        </tbody>
    </table>
</body>
<script>
    const status = document.getElementById('status');
    const result = document.getElementById('resultado');
    document.getElementById('btnConsultar').addEventListener('click', async () => {
        let txt = document.getElementById('txt');
        let numero = txt.value;

        if (numero.length != 8) {
            status.innerText = "El número debe tener 8 dígitos";
            return
        }

        numero = Number.parseInt(numero);

        if (Number.isNaN(numero)) {
            status.innerText = "El número debe ser válido.";
            return
        }

        init(document.getElementById('txt').value);
        txt.value = "";
    });

    async function init(numero) {
        status.innerText = "Consultando...";
        let newRow = document.createElement('tr');
        console.log("Telefono: " + numero);
        let a = await obtenerNombre(numero); //Saco el nombre
        console.log("Nombre: " + a);
        let b = await obtenerCedula(a); //Saco la cedula
        console.log("Cedula: " + b);
        let c = await obtenerFecha(b); //Saco fecha
        console.log("Fecha: " + c);

        let edad = "";
        if (c == "-") {
            edad = "-";
        } else {
            edad = new Date().getFullYear() - c.split("/")[2]
        }

        let provincia = "-";
        switch(b.charAt(0)) {
            case "1":
                provincia = "SAN JOSÉ";
                break;
            case "2":
                provincia = "ALAJUELA";
                break;
            case "3":
                provincia = "CARTAGO";
                break;
            case "4":
                provincia = "HEREDIA";
                break;
            case "5":
                provincia = "GUANACASTE";
                break;
            case "6":
                provincia = "PUNTARENAS";
                break;
            case "7":
                provincia = "LIMÓN";
                break;
            case "8":
                provincia = "EXTRANJERO";
                break;
        }

        let finalData = [b, a, edad, c, provincia, numero]

        for (let i of finalData) {
            let newTd = document.createElement('td');
            newTd.innerText = i;
            newRow.appendChild(newTd);
        }
        result.appendChild(newRow);

        status.innerText = "Listo.";
        document.querySelector("#resultado").style.display = "table";
    }

    async function obtenerNombre(numero) {
        const url = 'https://webbanking.cajadeande.fi.cr/IEntidadAppPMB/ipmb/obtener_clientemonedero';

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'codnumentidad': '0bf31f97-74d4-4825-a1a3-29a36ffd7f4d',
                    'numerocliente': numero,
                    'user-agent': 'Dart/3.5 (dart:io)',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            });

            const data = await response.json();
            let nombre = data.NombreCliente;
            return nombre.replaceAll('_', ' ').trim().toUpperCase();
        } catch (error) {
            status.innerText = "Error."
            console.log("Error en obtenerNombre" + error.message);
            return "-";
        }
    }

    async function obtenerCedula(nombre) {
        if (nombre == "-") {
            return "-";
        }

        const url = `https://apis.gometa.org/cedulas/${nombre}`

        try {
            const response = await fetch(url, {
                method: 'GET',
            });

            const data = await response.json();
            let cedula = data.results[0].cedula
            return cedula;
        } catch (error) {
            console.log("Error en obtenerCedula" + error.message);
            return "-";
        }
    }

    async function obtenerFecha(cedula) {
        if (cedula == "-") {
            return "-";
        }
        try {
            const response = await fetch('https://sicai.pcpuris.com/api/app/ObtieneInfoCedulaAppAdmin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json; charset=utf-8'
                },
                body: JSON.stringify({
                    "cedula": cedula,
                })
            });

            const data = await response.json();
            let fecha = data.nacimiento;
            return fecha;
        } catch (error) {
            console.log("Error en obtenerFecha" + error.message);
            return "-";
        }
    }

</script>

</html>